{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Detalles del paciente -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                    <h3 class="text-white fw-bold text-uppercase mb-0">DETALLE DEL PACIENTE</h3>
                    <!-- Botón para abrir el modal de edición del paciente -->
                    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#editarPacienteModal">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr><th>Nombre:</th><td>{{ paciente.nombre }}</td></tr>
                        <tr><th>Apellido:</th><td>{{ paciente.apellido }}</td></tr>
                        <tr><th>RUT:</th><td>{{ paciente.rut }}</td></tr>
                        <tr><th>Patología:</th><td>{{ paciente.patologia }}</td></tr>
                        <tr><th>Observaciones:</th><td>{{ paciente.observaciones }}</td></tr>
                        <tr><th>Sesiones:</th><td>{{ paciente.cantidad_sesiones }}</td></tr>
                        <tr>
                            <th>Estado:</th>
                            <td>
                                {% if paciente.estado == "En Proceso" %}
                                    <span class="badge bg-warning text-dark">{{ paciente.estado }}</span>
                                {% elif paciente.estado == "Terminado" %}
                                    <span class="badge bg-success">{{ paciente.estado }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ paciente.estado }}</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Tabla de sesiones -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h4 class="fw-bold text-uppercase mb-0">Sesiones</h4>
                    <!-- Formulario para añadir sesiones -->
                    <form method="POST" id="form-sesiones" class="d-flex align-items-center ms-auto">
                        {% csrf_token %}
                        <input type="number" id="cantidad-nueva" name="cantidad_nueva" min="1" class="form-control form-control-sm me-2" style="width: 80px; font-size: 0.9rem;">
                        <button type="submit" id="btn-agregar-sesiones" name="agregar_sesiones" class="btn btn-light btn-sm" style="font-size: 0.9rem;">Añadir</button>
                    </form>
                    <p id="mensaje-error" class="text-danger mt-1" style="font-size: 0.85rem; display: none;">Por favor, ingrese un número válido de sesiones.</p>
                </div>
                <div class="card-body">
                    {% if sesiones %}
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Asistencia</th>
                                    <th>Comentario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sesion in sesiones %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ sesion.fecha }}</td>
                                        <td>{{ sesion.hora }}</td>
                                        <td>
                                            {% if sesion.asistencia %}
                                                <span class="badge bg-success">Asistió</span>
                                            {% else %}
                                                <span class="badge bg-danger">No Asistió</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ sesion.comentario_asistencia|default:"Sin comentario" }}</td>
                                        <td>
                                            <!-- Botón para editar sesión -->
                                            <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editarSesionModal{{ sesion.id }}">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>

                                            {% if not sesion.asistencia %}
                                                <!-- Formulario para eliminar la sesión -->
                                                <form method="POST" action="{% url 'eliminar_sesion' sesion.id %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar esta sesión?');">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <span class="text-muted">No se puede borrar</span>
                                            {% endif %}
                                        </td>
                                    </tr>

                                    <!-- Modal para editar sesión -->
                                    <div class="modal fade" id="editarSesionModal{{ sesion.id }}" tabindex="-1" aria-labelledby="editarSesionModalLabel{{ sesion.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editarSesionModalLabel{{ sesion.id }}">Editar Sesión</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                                </div>
                                                <form method="POST">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="sesion_id" value="{{ sesion.id }}">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="fecha" class="form-label">Fecha</label>
                                                            <input type="date" class="form-control" name="fecha" value="{{ sesion.fecha|date:'Y-m-d' }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="hora" class="form-label">Hora</label>
                                                            <input type="time" class="form-control" name="hora" value="{{ sesion.hora }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="asistencia" class="form-label">Asistencia</label>
                                                            <select class="form-control" name="asistencia">
                                                                <option value="Sí" {% if sesion.asistencia %}selected{% endif %}>Sí</option>
                                                                <option value="No" {% if not sesion.asistencia %}selected{% endif %}>No</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="comentario_asistencia" class="form-label">Comentario</label>
                                                            <textarea class="form-control" name="comentario_asistencia" rows="2">{{ sesion.comentario_asistencia }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="submit" name="editar_sesion" class="btn btn-primary">Guardar Cambios</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">No hay sesiones registradas.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Archivos adjuntos -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="fw-bold text-uppercase mb-0" style="font-size: 1.2rem;">Archivos Adjuntos</h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="archivo" class="form-label">Seleccionar Archivo:</label>
                            <input type="file" name="archivo" id="archivo" class="form-control">
                        </div>
                        <button type="submit" name="subir_archivo" class="btn btn-success w-100 mb-3">
                            <i class="fas fa-upload"></i> Subir Archivo
                        </button>
                    </form>
                    {% if archivos %}
                        <ul class="list-group">
                            {% for archivo in archivos %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <a href="{{ archivo.archivo.url }}" target="_blank">{{ archivo.archivo.name }}</a>
                                    <form method="POST" action="{% url 'eliminar_archivo' archivo.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar archivo?');">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No hay archivos adjuntos.</p>
                    {% endif %}

                    <a href="{% url 'ingreso_pacientes' %}" class="btn btn-primary w-100 mt-3">
                        <i class="fas fa-user-plus"></i> Ingresar Nuevo Paciente
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar paciente -->
<div class="modal fade" id="editarPacienteModal" tabindex="-1" aria-labelledby="editarPacienteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarPacienteModalLabel">Editar Paciente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="POST" action="{% url 'editar_paciente' paciente.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    {{ form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('form-sesiones').addEventListener('submit', function (event) {
        const inputCantidad = document.getElementById('cantidad-nueva');
        const mensajeError = document.getElementById('mensaje-error');

        if (!inputCantidad.value || inputCantidad.value <= 0) {
            event.preventDefault(); // Evita que el formulario se envíe
            mensajeError.style.display = 'block'; // Muestra el mensaje de error
        } else {
            mensajeError.style.display = 'none'; // Oculta el mensaje de error si está todo bien
        }
    });
</script>
{% endblock %}
